# MermaidChartRefactored Component

## Overview

The `MermaidChartRefactored` component is a simplified and improved version of the original MermaidChart component. It reduces the container hierarchy, eliminates redundant styling layers, and provides a more consistent approach to scaling and styling mermaid diagrams. It now supports comprehensive diagram styling options based on Mermaid's configuration capabilities.

## Container Hierarchy

The refactored component uses a simplified container structure:

1. **mermaid-container** (Outermost)
   - **RESPONSIBILITY**: Component boundary and positioning
   - Handles overall position and dimensions
   - Manages the loading state visualization
   - Provides the debugging context

2. **mermaid-chart** (Inner container with ref)
   - **RESPONSIBILITY**: SVG container and styling context
   - Holds the rendered SVG content
   - Applies CSS classes and data attributes for styling
   - Serves as the context for CSS variables

3. **svg** (Generated by mermaid.js)
   - **RESPONSIBILITY**: Diagram rendering
   - Contains the actual diagram elements
   - Receives width/height attributes
   - Contains the viewBox information

4. **svg > g** (Root group)
   - **RESPONSIBILITY**: Scaling control
   - Target for transform scale operations
   - Centers the diagram via transform-origin

## Key Improvements

1. **Reduced Nesting Levels**
   - Eliminated redundant containers (2 fewer than original)
   - Combined responsibilities of similar containers
   - Clearer separation of concerns

2. **Consistent Styling Approach**
   - Moved styling to CSS file
   - Used CSS variables for dynamic values
   - Applied data attributes for state-based styling

3. **Improved Scaling Control**
   - Added explicit scale prop for direct control
   - Used single transform approach for scaling
   - Maintained backward compatibility with class-based scaling

4. **Enhanced Debugging**
   - Added debug mode to visualize container boundaries
   - Exposed container and SVG dimensions
   - Added data attributes for tracking state

5. **Comprehensive Styling Options**
   - Support for Mermaid themes (default, neutral, dark, forest, base)
   - Support for visual looks (neo, handDrawn, classic)
   - Custom theme variables for fine-grained control
   - Class definitions for node styling
   - Layout direction control

## Props

| Prop             | Type                   | Default     | Description                              |
|------------------|-----------------------|-------------|------------------------------------------|
| definition       | string                | (required)  | The mermaid diagram definition           |
| className        | string                | ''          | Additional class names                   |
| style            | React.CSSProperties   | {}          | Custom style for the container           |
| debug            | boolean               | false       | Enable debug visualization               |
| theme            | MermaidTheme          | undefined   | Theme to use (default, neutral, dark, forest, base) |
| look             | MermaidLook           | undefined   | Visual style (neo, handDrawn, classic)   |
| themeVariables   | MermaidThemeVariables | undefined   | Custom theme variables (colors, fonts, etc.) |
| layoutDirection  | string                | undefined   | Layout direction (TD, TB, BT, LR, RL)    |
| handDrawnSeed    | number                | undefined   | Seed for handDrawn look randomization    |
| classDefinitions | object                | undefined   | Node class definitions for styling       |

## Styling Options

### Themes

The component supports all Mermaid themes:
- `default`: Standard light theme
- `neutral`: Clean, minimalist theme
- `dark`: Dark mode theme with light text
- `forest`: Nature-inspired green theme
- `base`: Minimal theme for custom styling with theme variables

### Looks

Visual styles for the diagrams:
- `neo`: Modern, clean appearance
- `handDrawn`: Sketch-like, informal look
- `classic`: Traditional diagram appearance

### Theme Variables

Fine-grained control of diagram appearance (works best with `base` theme):
- `primaryColor`: Main color used for nodes and elements
- `primaryTextColor`: Text color for primary elements
- `lineColor`: Color for connecting lines and arrows
- `fontFamily`: Font for all text elements
- `fontSize`: Base font size for the diagram

### Layout Direction

Controls the flow direction of the diagram:
- `TD` or `TB`: Top-down (default)
- `LR`: Left to right
- `RL`: Right to left
- `BT`: Bottom to top

### Class Definitions

Custom styles for node classes in the format:
```javascript
{
  "className": "fill:#ff0000,stroke:#0000ff,color:white,stroke-width:2px"
}
```

Supported style attributes:
- `fill`: Background color
- `stroke`: Border color
- `stroke-width`: Border thickness
- `color`: Font color
- `rx`, `ry`: Border radius (rounded corners)
- `font-size`: Font size
- `font-family`: Font name
- `font-weight`: Text weight
- `padding`: Internal padding
- `text-align`: Text alignment

## CSS Variables

The component exposes several CSS variables that can be used to style the diagram:

- `--background-color`: Background color of the SVG
- `--text-font-size`: Font size for node text
- `--text-font-weight`: Font weight for node text
- `--border-radius`: Border radius for nodes and clusters
- `--svg-natural-width`: Natural width of the SVG from viewBox
- `--svg-natural-height`: Natural height of the SVG from viewBox
- `--svg-aspect-ratio`: Aspect ratio of the SVG

## Data Attributes

The component adds the following data attributes for styling and debugging:

- `data-chart-state`: Current state of the chart ('rendering' or 'ready')
- `data-chart-type`: Type of chart ('mermaid')
- `data-debug`: Whether debug mode is enabled ('true' or not present)
- `data-node-type`: Type of node ('standard' or other types)
- `data-subgraph`: For subgraph elements ('true')
- `data-theme`: Current theme (if specified)
- `data-look`: Current look (if specified)

## Usage Examples

### Basic Usage

```tsx
import MermaidChartRefactored from '../components/ui/MermaidChartRefactored';
import '../components/ui/MermaidChart.css';

const MyComponent = () => {
  const diagram = `
    graph TD
      A[Start] --> B{Decision?}
      B -->|Yes| C[Process 1]
      B -->|No| D[Process 2]
      C --> E[End]
      D --> E
  `;

  return (
    <div style={{ width: '800px', height: '400px' }}>
      <MermaidChartRefactored
        definition={diagram}
        className="my-diagram"
        debug={false}
      />
    </div>
  );
};
```

### With Custom Theme and Look

```tsx
import MermaidChartRefactored from '../components/ui/MermaidChartRefactored';

const MyComponent = () => {
  const diagram = `
    graph LR
      A[Start] --> B{Decision?}
      B -->|Yes| C[Process 1]
      B -->|No| D[Process 2]
      C --> E[End]
      D --> E
  `;

  return (
    <div style={{ width: '800px', height: '400px' }}>
      <MermaidChartRefactored
        definition={diagram}
        theme="forest"
        look="handDrawn"
        handDrawnSeed={5}
        layoutDirection="LR"
      />
    </div>
  );
};
```

### With Custom Theme Variables

```tsx
import MermaidChartRefactored from '../components/ui/MermaidChartRefactored';

const MyComponent = () => {
  const diagram = `
    graph TD
      A[Start] --> B{Decision?}
      B -->|Yes| C[Process 1]
      B -->|No| D[Process 2]
      C --> E[End]
      D --> E
  `;

  const themeVariables = {
    primaryColor: "#673AB7",
    primaryTextColor: "#ffffff",
    lineColor: "#03A9F4",
    fontFamily: "Courier New",
    fontSize: "18px"
  };

  return (
    <div style={{ width: '800px', height: '400px' }}>
      <MermaidChartRefactored
        definition={diagram}
        theme="base"
        themeVariables={themeVariables}
      />
    </div>
  );
};
```

### With Class Definitions

```tsx
import MermaidChartRefactored from '../components/ui/MermaidChartRefactored';

const MyComponent = () => {
  const diagram = `
    graph TD
      A[Start] --> B{Decision?}
      B -->|Yes| C[Process 1]
      B -->|No| D[Process 2]
      C --> E[End]
      D --> E
      
      class A start
      class B decision
      class C,D process
      class E end
  `;

  const classDefinitions = {
    start: "fill:#2196F3,stroke:#1976D2,color:white,stroke-width:1.5px,rx:10,ry:10",
    decision: "fill:#9C27B0,stroke:#7B1FA2,color:white,stroke-width:1.5px,rx:10,ry:10",
    process: "fill:#4CAF50,stroke:#388E3C,color:white,stroke-width:1.5px,rx:10,ry:10",
    end: "fill:#FF9800,stroke:#F57C00,color:white,stroke-width:1.5px,rx:10,ry:10"
  };

  return (
    <div style={{ width: '800px', height: '400px' }}>
      <MermaidChartRefactored
        definition={diagram}
        classDefinitions={classDefinitions}
      />
    </div>
  );
};
```

### Glassmorphism Effect Example

```tsx
import MermaidChartRefactored from '../components/ui/MermaidChartRefactored';

const MyComponent = () => {
  const diagram = `
    graph TD
      A[Base LLM] --> B[Agent]
      B --> C[Integration API]
      C --> D[User Interface]
      
      class A,B,D glass
      class C borderless
  `;

  const classDefinitions = {
    glass: "fill:#ffffff20,stroke:#ffffffaa,color:#ffffff,font-size:14px,stroke-width:1.5px,rx:10,ry:10",
    borderless: "fill:#ffffff10,stroke:none,color:white,font-size:14px,rx:10,ry:10"
  };

  return (
    <div style={{ width: '800px', height: '400px', background: 'linear-gradient(45deg, #333, #111)' }}>
      <MermaidChartRefactored
        definition={diagram}
        theme="dark"
        look="neo"
        classDefinitions={classDefinitions}
      />
    </div>
  );
};
```

## Migration from Original MermaidChart

To migrate from the original MermaidChart component:

1. Import both the component and CSS file:
   ```tsx
   import MermaidChartRefactored from '../components/ui/MermaidChartRefactored';
   import '../components/ui/MermaidChart.css';
   ```

2. Replace `MermaidChart` with `MermaidChartRefactored` in your JSX

3. Add the `scale` prop if you were previously using view-specific CSS classes:
   ```tsx
   // Before (using class-based scaling)
   <MermaidChart
     definition={diagram}
     className="initial"
   />
   
   // After (using explicit scaling)
   <MermaidChartRefactored
     definition={diagram}
     scale={0.9} // equivalent to the .initial class scale
   />
   ```

4. If you had custom styling for the SVG elements, migrate to use CSS variables or the new styling props:
   ```css
   /* Before */
   .my-diagram svg {
     background-color: #f5f5f5;
   }
   
   /* After - CSS approach */
   .my-diagram {
     --background-color: #f5f5f5;
   }
   
   /* Or with props approach */
   <MermaidChartRefactored
     definition={diagram}
     theme="base"
     themeVariables={{ 
       primaryColor: "#f5f5f5"
     }}
   />
   ```

## Testing

To test the component, you can use the test routes:

- `/test/mermaid`: Original MermaidChart component
- `/test/mermaid-refactored`: Refactored MermaidChart component

These routes provide interactive controls for testing different diagram complexities, scaling factors, and debug mode.

## Debugging Tips

- Use the debug prop to visualize container boundaries
- Check the browser console for any rendering errors
- Test your diagram in the [Mermaid Live Editor](https://mermaid.live) first
- Use the data attributes for CSS selector targeting and debugging